#!/bin/bash
# ============================================================
# Crypto Monitor - Docker å®Œæ•´éƒ¨ç½²è„šæœ¬
# ============================================================
# ä½¿ç”¨æ–¹æ³•: bash scripts/docker_deploy.sh
# ============================================================

set -e

echo "============================================================"
echo "  Crypto Monitor - Docker å®Œæ•´éƒ¨ç½²"
echo "  $(date)"
echo "============================================================"

PROJECT_DIR="/root/v8.3_crypto_monitor"
DOCKER_DIR="$PROJECT_DIR/docker"

cd $PROJECT_DIR

# ============================================================
# æ­¥éª¤ 1: åœæ­¢æ‰€æœ‰ç›´æ¥è¿è¡Œçš„è¿›ç¨‹
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 1: åœæ­¢ç›´æ¥è¿è¡Œçš„è¿›ç¨‹..."

pkill -f "unified_runner" 2>/dev/null || true
pkill -f "dashboards.unified" 2>/dev/null || true
pkill -f "python -m src" 2>/dev/null || true

sleep 2
echo "   âœ… è¿›ç¨‹å·²åœæ­¢"

# ============================================================
# æ­¥éª¤ 2: åœæ­¢ç³»ç»Ÿ Redis
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 2: åœæ­¢ç³»ç»Ÿ Redis..."

systemctl stop redis-server 2>/dev/null || true
systemctl disable redis-server 2>/dev/null || true

echo "   âœ… ç³»ç»Ÿ Redis å·²åœæ­¢"

# ============================================================
# æ­¥éª¤ 3: å‡†å¤‡ Docker ç¯å¢ƒ
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 3: å‡†å¤‡ Docker ç¯å¢ƒ..."

# å¤åˆ¶ .env åˆ° docker ç›®å½•
cp $PROJECT_DIR/.env $DOCKER_DIR/.env
echo "   âœ… .env å·²å¤åˆ¶"

# ç¡®ä¿ config.secret ç›®å½•å­˜åœ¨ä¸”æœ‰æ­£ç¡®æƒé™
mkdir -p $PROJECT_DIR/config.secret
chmod 755 $PROJECT_DIR/config.secret
echo "   âœ… config.secret ç›®å½•å·²å‡†å¤‡"

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
mkdir -p $PROJECT_DIR/logs
echo "   âœ… logs ç›®å½•å·²å‡†å¤‡"

# ============================================================
# æ­¥éª¤ 4: åœæ­¢æ—§çš„ Docker å®¹å™¨
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 4: åœæ­¢æ—§çš„ Docker å®¹å™¨..."

cd $DOCKER_DIR
docker compose down --remove-orphans 2>/dev/null || true

echo "   âœ… æ—§å®¹å™¨å·²åœæ­¢"

# ============================================================
# æ­¥éª¤ 5: æ„å»ºå¹¶å¯åŠ¨ Docker æœåŠ¡
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 5: æ„å»ºå¹¶å¯åŠ¨ Docker æœåŠ¡..."
echo "   (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ...)"

docker compose build --no-cache

echo ""
echo "ğŸ“Œ å¯åŠ¨æœåŠ¡..."
docker compose up -d

echo "   âœ… Docker æœåŠ¡å·²å¯åŠ¨"

# ============================================================
# æ­¥éª¤ 6: ç­‰å¾…æœåŠ¡å¥åº·
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 6: ç­‰å¾…æœåŠ¡å¥åº·æ£€æŸ¥..."

sleep 10

# æ£€æŸ¥ Redis
echo -n "   Redis: "
if docker exec crypto-redis redis-cli -a "$REDIS_PASSWORD" ping 2>/dev/null | grep -q PONG; then
    echo "âœ… å¥åº·"
else
    echo "â³ ç­‰å¾…ä¸­..."
    sleep 10
fi

# ============================================================
# æ­¥éª¤ 7: æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 7: æœåŠ¡çŠ¶æ€"
echo "============================================================"

docker compose ps

# ============================================================
# æ­¥éª¤ 8: æ˜¾ç¤ºæ•°æ®å·ä¿¡æ¯
# ============================================================
echo ""
echo "ğŸ“Œ æ­¥éª¤ 8: æ•°æ®æŒä¹…åŒ–å·"
echo "============================================================"

docker volume ls | grep crypto || echo "   (æš‚æ— æ•°æ®å·)"

echo ""
echo "   æ•°æ®å­˜å‚¨ä½ç½®:"
echo "   - Redis æ•°æ®: docker volume inspect docker_redis_data"
echo "   - Prometheus: docker volume inspect docker_prometheus_data"
echo "   - Grafana: docker volume inspect docker_grafana_data"

# ============================================================
# å®Œæˆ
# ============================================================
echo ""
echo "============================================================"
echo "  âœ… Docker éƒ¨ç½²å®Œæˆï¼"
echo "============================================================"
echo ""
echo "  ğŸ“Š Dashboard:  http://45.32.104.8:5000"
echo "  ğŸ“ˆ Grafana:    http://45.32.104.8:3000"
echo "  ğŸ“‰ Prometheus: http://45.32.104.8:9090"
echo ""
echo "  å¸¸ç”¨å‘½ä»¤:"
echo "  - æŸ¥çœ‹æ—¥å¿—: docker compose logs -f"
echo "  - æŸ¥çœ‹çŠ¶æ€: docker compose ps"
echo "  - é‡å¯æœåŠ¡: docker compose restart"
echo "  - åœæ­¢æœåŠ¡: docker compose down"
echo ""
echo "  æ•°æ®æŒä¹…åŒ–:"
echo "  - Redis æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ° docker volume"
echo "  - é‡å¯ä¸ä¼šä¸¢å¤±æ•°æ®"
echo "============================================================"

